#!/bin/bash

set -e

OPTS=$(getopt --longoptions=db:,user:,password:,standalone,address:,port:,remote: -n ${0##*/} -- d:u:p:sa:t:r: "$@")

if [ $? != 0 ] ; then echo "Terminating..." >&2 ; exit 1 ; fi

eval set -- "$OPTS"

PGNAME=""
PGUSER=""
PGPASSWORD=""
STANDALONE=false
ADDRESS=""
PORT=""
REMOTE=""

while true ; do
    case "$1" in
        -d|--db)
            PGNAME=$2
            shift
            ;;
        -u|--user)
            PGUSER=$2
            shift
            ;;
        -p|--password)
            PGPASSWORD=$2
            shift
            ;;
        -s|--standalone)
            STANDALONE=true
            ;;
        -a|--address)
            ADDRESS=$2
            shift
            ;;
        -t|--port)
            PORT=$2
            shift
            ;;
        -r|--remote)
            REMOTE=$2
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "Internal error [$1]!" >&2
            exit 1
            ;;
    esac
    shift
done

if [ -z $PORT ] || ! $STANDALONE; then
    PORT=5432
fi

help() {
    echo "Usage: $(basename $0) create [options]" >&2
    echo "       $(basename $0) remove [options]" >&2
    echo "       $(basename $0) check  [options]" >&2
    echo ""
    echo "Options for the 'create' command:"
    echo "    --db <database-name>         Name of the database to create"
    echo "    --user <username>            Database user to create"
    echo "    --password <password>        Password for the database user"
    echo "    --standalone                 Configure the database server to be remotely accessible"
    echo "    --address <local-addresses>  Comma-separated list of local addresses to listen on"
    echo "                                 Use '*' for all addresses"
    echo "    --port <local-port>          Local port to listen on."
    echo "    --remote <remote-addresses>  Comma-separated list of remote addresses to allow connections from"
    echo ""
    echo "Options for the 'remove' command:"
    echo "    --db <database-name>         Name of the database to remove"
    echo "    --user <username>            Name of the user to remove"
    echo ""
    echo "Options for the 'check' command:"
    echo "    --db <database-name>         Name of the database to check for"
    echo "    --user <username>            Name of the user to check for"
}

ask() {
    if $1; then
        read -p "$2" $3
    else
        read -s -p "$2" $3
    fi
}

PG_DATA=/var/lib/pgsql/data
PG_HBA="$PG_DATA/pg_hba.conf"
POSTGRESQL="$PG_DATA/postgresql.conf"
PG_PIDFILE="/var/run/postmaster.$PORT.pid"
PG_SOCKET="/tmp/.s.PGSQL.$PORT"
SPACEWALK_TARGET="/usr/lib/systemd/system/spacewalk.target"
SERVICE_LIST="/etc/rhn/service-list"

create() {
    [ -z "$PGNAME" ] && ask true "Database name: " PGNAME
    [ -z "$PGUSER" ] && ask true "Database user: " PGUSER
    [ -z "$PGPASSWORD" ] && ask false "Database password: " PGPASSWORD && echo

    if $STANDALONE; then
        [ -z "$ADDRESS" ] && ask true "Local addresses to listen on (comma-separated, RETURN for all): " ADDRESS
        [ -z "$ADDRESS" ] && ADDRESS="'*'"
        [ -z "$REMOTE" ] && ask true "Remote addresses to allow connection from (CIDR format, comma-separated): " REMOTE
    fi

    postgresql_service enable

    if [ ! -d "$PG_DATA/base" ] ; then
        postgresql_service initdb

        if $STANDALONE; then
            sed -i 's/^\(\s*listen_addresses.*|\s*port.*\)$/### next line has been commented out by spacewalk-setup-postgresql ###\n##\1/' $POSTGRESQL
        fi

	# see bug 821446, we enable timestamps in logs by default
	sed -i 's/^\(\s*max_connections.*\|\s*shared_buffers.*\)$/### next line has been commented out by spacewalk-setup-postgresql ###\n##\1/' $POSTGRESQL
        cat >> $POSTGRESQL <<EOF

### spacewalk-setup-postgresql modified values
checkpoint_completion_target = 0.7
checkpoint_segments = 8
effective_cache_size = 1152MB
log_line_prefix = '%m '
maintenance_work_mem = 96MB
max_connections = 600
shared_buffers = 384MB
wal_buffers = 4MB
work_mem = 2560kB
$STANDALONE_SETUP
EOF

        if $STANDALONE; then
            cat >> $POSTGRESQL <<EOF
### spacewalk-setup-postgresql modified values for a standalone PostgreSQL database
listen_addresses=$ADDRESS
port=$PORT
EOF
        fi

        sysctl kernel.shmmax | ( read v v v ; LIMIT=500000000 ; if [ "0$v" -lt $LIMIT ] ; then sysctl "kernel.shmmax=$LIMIT" >> /etc/sysctl.conf ; fi )

        sed -i 's/^\([^#].*\)$/### next line has been commented out by spacewalk-setup-postgresql: ###\n##\1/ ' $PG_HBA
        cat >> $PG_HBA <<EOF

local $PGNAME $PGUSER md5
host  $PGNAME $PGUSER 127.0.0.1/8 md5
host  $PGNAME $PGUSER ::1/128 md5
local $PGNAME postgres ident
local postgres postgres ident

EOF

        if $STANDALONE; then
            for ADDR in $(echo $REMOTE|sed 's/,/ /g' ); do
                cat >> $PG_HBA <<EOF
host $PGNAME $PGUSER $ADDR md5
EOF
            done
        fi
    fi

    postgresql_service start

    if /usr/sbin/lsof /proc > /dev/null ; then
        while [ -f "$PG_PIDFILE" ] ; do
            # wait for postmaster to be ready
            /usr/sbin/lsof -t -p $(cat "$PG_PIDFILE" 2>/dev/null) -a "$PG_SOCKET" > /dev/null  \
                && break
            sleep 1
        done
    fi

    if ! exists_db ; then
            runuser - postgres -c "createdb '$PGNAME'"
    fi
    if ! exists_plpgsql ; then
            runuser - postgres -c "createlang plpgsql '$PGNAME'"
    fi
    if ! exists_user ; then
            runuser - postgres -c "yes '$PGPASSWORD' | createuser -P -sDR '$PGUSER'"
    fi

    postgresql_service reload

    if [ -e "$SPACEWALK_TARGET" ] ; then
        if ! grep -q 'Requires=postgresql.service' "$SPACEWALK_TARGET" ; then
             sed -i 's/\(Description=Spacewalk\)/\1\nRequires=postgresql.service/' "$SPACEWALK_TARGET"
        fi
    elif [ -e "$SERVICE_LIST" ]; then
        if ! grep -q 'SERVICES=.*postgresql' "$SERVICE_LIST" ; then
             echo '' >>"$SERVICE_LIST"
             echo '# added by spacewalk-setup-postgresql' >>"$SERVICE_LIST"
             echo 'SERVICES="postgresql $SERVICES"' >>"$SERVICE_LIST"
        fi
    fi
}

remove() {
    if [ -z "$PGUSER" -a -z "$PGNAME" ] ; then
        help
        exit 1
    fi
    if exists_db ; then
            runuser - postgres -c "dropdb '$PGNAME'"
    fi
    if exists_user ; then
            runuser - postgres -c "dropuser '$PGUSER'"
    fi
}

check() {
    if [ -z "$PGUSER" -a -z "$PGNAME" ] ; then
        help
        exit 1
    fi

    postgresql_service status >& /dev/null || postgresql_service start

    RET=0
    if [ -n "$PGUSER" ] ; then
        if exists_user ; then
            echo "User \"$PGUSER\" already exists"
        else
            echo "User \"$PGUSER\" does not exist"
            RET=1
        fi
    fi
    if [ -n "$PGNAME" ] ; then
        if exists_db ; then
            echo "Database \"$PGNAME\" already exists"
        else
            echo "Database \"$PGNAME\" does not exist"
            RET=1
        fi
    fi
    exit $RET
}

exists_db() {
    EXISTS=$(runuser - postgres -c 'psql -t -c "select datname from pg_database where datname='"'$PGNAME'"';"')
    if [ "x$EXISTS" == "x $PGNAME" ] ; then
        return 0
    else
        return 1
    fi
}

exists_plpgsql() {
    EXISTS=$(runuser - postgres -c 'psql -At -c "select lanname from pg_catalog.pg_language where lanname='"'plpgsql'"';"'" $PGNAME")
    if [ "x$EXISTS" == "xplpgsql" ] ; then
        return 0
    else
        return 1
    fi
}

exists_user() {
    EXISTS=$(runuser - postgres -c 'psql -t -c "select usename from pg_user where usename='"'$PGUSER'"';"')
    if [ "x$EXISTS" == "x $PGUSER" ] ; then
        return 0
    else
        return 1
    fi
}

postgresql_service() {
    if [ -e "$SPACEWALK_TARGET" ] ; then
        case $1 in
            initdb) postgresql-setup initdb ;;
                 *) systemctl $1 postgresql ;;
        esac
    else
        case $1 in
            enable) chkconfig postgresql on ;;
                 *) service postgresql $1 ;;
        esac
    fi
}

case $1 in
        create) create
            ;;
        remove) remove
            ;;
        check)  check
            ;;
        *)      help
            ;;
esac
