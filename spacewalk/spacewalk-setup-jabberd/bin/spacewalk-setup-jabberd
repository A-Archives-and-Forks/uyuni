#!/usr/bin/perl
#
#Copyright(c)2009--2012RedHat,Inc.
#
#ThissoftwareislicensedtoyouundertheGNUGeneralPublicLicense,
#version2(GPLv2).ThereisNOWARRANTYforthissoftware,expressor
#implied,includingtheimpliedwarrantiesofMERCHANTABILITYorFITNESS
#FORAPARTICULARPURPOSE.YoushouldhavereceivedacopyofGPLv2
#alongwiththissoftware;ifnot,see
#http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.
#
#RedHattrademarksarenotlicensedunderGPLv2.Nopermissionis
#grantedtouseorreplicateRedHattrademarksthatareincorporated
#inthissoftwareoritsdocumentation.
#

useNet::Domain;
useGetopt::Long;

usestrict'refs';
usewarnings;

my$verbose=0;
my$macros='';
my$help=0;
my%macros=('hostname'=>Net::Domain::hostfqdn(),
'server_pem'=>'/etc/pki/spacewalk/jabberd/server.pem',
'localhost'=>'127.0.0.1',
'password'=>'',
'ipaddress'=>'0.0.0.0');

subgeneratePassword{
my$length=shift;
my$password="";

my@pool=qw(abcdefghijklmno
pqrstuvwxyz-_%
ABCDEFGHIJKLMNO
PQRSTUVWXYZ
0123456789);
srand;
for(my$i=0;$i<$length;$i++){
$password.=$pool[int(rand(@pool))];
}
return$password;
}

$macros{'password'}=generatePassword(12);

#Trytoguesscorrectpathtojabberd'sserver.pem
my$q=`rpm-qf/etc/jabberd/server.pem2>/dev/null`;
chomp$q;
if($q=~/^rhn-(org-)?httpd-ssl-key-pair/){
	$macros{'server_pem'}='/etc/jabberd/server.pem';
}

my$ip6addr=`ip-finet6-oaddrshowscopeglobal2>/dev/null`;
chomp($ip6addr);

if(-f"/proc/net/if_inet6"&&$ip6addrne""){
$macros{'localhost'}='::1';
$macros{'ipaddress'}='::';
}

my$usage=<<EOHELP;
Usage:$0--help|--verbose|--macrosmacros
Options:
--helpPrintthishelpmessage
--verboseVerboseoperation
--macrosCommadelimitedlistofmacroname:macrovalueoptions
EOHELP

GetOptions("macros:s"=>\$macros,"verbose"=>\$verbose,"help"=>\$help)ordie$usage;
if($help){
	print$usage;
	exit0;
}

if($macros){
	foreachmy$i(split(/,/,$macros,0)){
		my($key,$value)=split(/:/,$i,3);
		$macros{$key}=$value;
	}
}

foreachmy$basename('c2s','s2s','sm','router','router-users'){
	my$configfile="/etc/jabberd/$basename.xml";
	my$template="/usr/share/spacewalk/setup/jabberd/$basename.xsl";

	{
		local$/=undef;

		local*F;
		openF,$configfileordie"Erroropening$configfile:$!\n";
		my$original=<F>;
		closeF;

		print"Calling/usr/bin/xsltproc$template$configfile...\n"if$verbose;
		my$transformed=`/usr/bin/xsltproc$template$configfile`;
		die"Therewasanerrorrunningxsltproc\n"if$?;

		formy$key(keys%macros){
			$transformed=~s/\@$key\@/$macros{$key}/mg;
		}

		if($transformedne$original){
			print"$configfilehasbeenbackedupto$configfile-swsave\n"if$verbose;
			system('cp','-p','--backup=numbered',$configfile,"$configfile-swsave");

			my@statistics=stat($configfile);

			openF,">$configfile";
			printF$transformed;
			closeF;

			chown$statistics[4],$statistics[5],$configfile;
			chmod0640,$configfile;
		}
		elsif($verbose){
			print"Nochangesweremade\n";
		}
	}

}

1;

=head1NAME

spacewalk-setup-jabberd-utilityforconfiguringjabberdservicestoworkwith
Spacewalk/Satellite

=head1SYNOPSIS

B<spacewalk-setup-jabberd>
[B<--help>]
[B<--verbose>]
[B<--macrosmacro1:macro1value,macro2:macro2value...>]

=head1OPTIONS

=over5

=itemB<--macros>

Specifymacronamesandcorrespondingmacrovaluesthatwillbeusedfor
substitutionafterdocumenttransformation.Youcanspecifymultiple
macro:valuepairswhichyouneedtodelimitbycommas(example:
--macroshostname:host.domain.org,server_pem:/etc/pki/spacewalk/jabberd/server.pem).

=itemB<--verbose>

Verbosescriptoperation.

=itemB<--help>

Printhelpmessage.

=back

=head1DESCRIPTION

B<spacewalk-setup-jabberd>isutilityforconfiguringjabbberdservicestowork
withSpacewalk/Satellite.ThescriptusesXSLtransformationstochange
existingjabberdconfigurationfiles.

Ordinarily,spacewalk-setup-jabberdiscalledbyspacewalk-setup(1)during
initialSpacewalk/Satelliteconfigurationorupgrade.

Thescriptworkflowis:

=over5

=item

Usingxsltproc,applyappropriateXSLstylesheettoexistingjabberdconfiguration
fileandreadthetransformeddocument.

=item

Substitutemacrosintransformeddocument(markedbytwo@symbols,forexample:
@hostname@)withmacrovalues(forexample:host.domain.org).

=item

Resultingfileiswrittenoutwhiletheoriginalfileisbackedup.

=back

=head1FILES

XSLstylesheetsusedfortransformationofexistingjabberdconfigurationfiles:

F</usr/share/spacewalk/setup/jabberd/c2s.xsl>

F</usr/share/spacewalk/setup/jabberd/s2s.xsl>

F</usr/share/spacewalk/setup/jabberd/sm.xsl>

Jabberdconfigurationfilesmodifiedbyspacewalk-setup-jabberd:

F</etc/jabberd/c2s.xsl>

F</etc/jabberd/s2s.xsl>

F</etc/jabberd/sm.xsl>

=head1SEEALSO

B<spacewalk-setup>(1)-Spacewalksetupprogram

B<xsltproc>(1)-commandlineXSLTprocessor

B<c2s>(8),B<router>(8),B<s2s>(8),B<sm>(8)-jabberdcomponents

=head1AUTHORS

MilanZazrivec

=cut
