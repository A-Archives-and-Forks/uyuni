<datasource_modes>

<mode name="system_scap_enabled_check">
  <query params="user_id, sid">
  SELECT count(cc.server_id) as count
      FROM rhnClientCapability CC
          INNER JOIN rhnClientCapabilityName ccn on cc.capability_name_id = ccn.id
          INNER JOIN rhnUserServerPerms usp on cc.server_id = usp.server_id
      WHERE usp.user_id = :user_id
          AND cc.server_id = :sid
          AND ccn.name LIKE 'scap%'
  </query>
</mode>

<mode name="show_system_scans">
  <query params="sid">
  SELECT tr.id, tr.identifier as test_result, rrt.label, count(*) as figure,
      TO_CHAR(sa.completion_time, 'YYYY-MM-DD HH24:MI:SS') AS completion_time
      FROM rhnXccdfTestresult tr,
          rhnXccdfRuleresult rr,
          rhnXccdfRuleresultType rrt,
          rhnActionScap ras,
          rhnServerAction sa
      WHERE tr.server_id = :sid
          AND tr.id = rr.testresult_id
          AND rr.result_id = rrt.id
          AND tr.action_scap_id = ras.id
          AND sa.server_id = tr.server_id
          AND sa.action_id = ras.action_id
      GROUP BY tr.id, tr.identifier, rrt.label, sa.completion_time
      ORDER BY tr.id DESC
  </query>
</mode>

<mode name="show_ruleresults" class="com.redhat.rhn.frontend.dto.XccdfRuleResultDto">
  <query params="xid">
  SELECT rr.id, rrt.label
      FROM rhnXccdfRuleresult rr,
          rhnXccdfRuleresultType rrt
      WHERE rr.testresult_id = :xid
          AND rr.result_id = rrt.id
      ORDER BY rrt.id
  </query>
</mode>

<mode name="idents_per_ruleresult" class="com.redhat.rhn.frontend.dto.XccdfIdentDto">
  <query params="rr_id">
  SELECT xi.id, xi.identifier, xis.system
      FROM rhnXccdfRuleIdentMap rim,
          rhnXccdfIdent xi,
          rhnXccdfIdentSystem xis
      WHERE rim.rresult_id = :rr_id
          AND rim.ident_id = xi.id
          AND xi.identsystem_id = xis.id
      ORDER BY xis.system
  </query>
</mode>

</datasource_modes>
