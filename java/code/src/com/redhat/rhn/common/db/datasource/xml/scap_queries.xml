<datasource_modes>

<mode name="system_scap_enabled_check">
  <query params="user_id, sid">
  SELECT count(cc.server_id) as count
      FROM rhnClientCapability CC
          INNER JOIN rhnClientCapabilityName ccn on cc.capability_name_id = ccn.id
          INNER JOIN rhnUserServerPerms usp on cc.server_id = usp.server_id
      WHERE usp.user_id = :user_id
          AND cc.server_id = :sid
          AND ccn.name LIKE 'scap%'
  </query>
</mode>

<mode name="show_system_scans">
  <query params="sid">
  SELECT tr.id, tr.identifier as test_result, rrt.label, count(rr.*),
      TO_CHAR(sa.completion_time, 'YYYY-MM-DD HH24:MI:SS') AS completion_time
      FROM rhnXccdfTestresult tr,
          rhnXccdfRuleresult rr,
          rhnXccdfRuleresultType rrt,
          rhnActionScap ras,
          rhnServerAction sa
      WHERE tr.server_id = :sid
          AND tr.id = rr.testresult_id
          AND rr.result_id = rrt.id
          AND tr.action_scap_id = ras.id
          AND sa.server_id = tr.server_id
          AND sa.action_id = ras.action_id
      GROUP BY tr.id, tr.identifier, rrt.label, sa.completion_time
      ORDER BY tr.id DESC
  </query>
</mode>

</datasource_modes>
